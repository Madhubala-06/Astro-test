---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Sidebar from '../../components/Sidebar.astro';
import { sanityClient, urlFor } from '../../lib/sanity';

export async function getStaticPaths() {
  try {
    // Fetch all posts with their slugs
    const posts = await sanityClient.fetch(`
      *[_type == "blogPost"] {
        "slug": slug.current
      }
    `);

    // If no posts exist, return empty array
    if (!posts || posts.length === 0) {
      console.log('‚ö†Ô∏è No blog posts found in Sanity. Create some posts first!');
      return [];
    }

    return posts.map((post: any) => ({
      params: { slug: post.slug }
    }));
  } catch (error) {
    console.error('Error fetching blog posts:', error);
    return [];
  }
}

const { slug } = Astro.params;

// Fetch the blog post with all related data in ONE query (faster!)
const data = await sanityClient.fetch(`
  {
    "post": *[_type == "blogPost" && slug.current == $slug][0] {
      title,
      slug,
      excerpt,
      coverImage,
      author,
      publishedAt,
      category,
      tags,
      content
    },
    "relatedPosts": *[_type == "blogPost" && slug.current != $slug && category == ^.post.category] | order(publishedAt desc)[0...3] {
      title,
      slug,
      excerpt,
      coverImage,
      publishedAt
    }
  }
`, { slug });

const post = data?.post;
const relatedPosts = data?.relatedPosts || [];

// If post doesn't exist, redirect to blog page
if (!post) {
  return Astro.redirect('/blog');
}

// Format date
const formatDate = (date: string) => {
  return new Date(date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};

// Convert portable text to HTML (simple version)
const renderContent = (content: any[]) => {
  if (!content) return '';
  
  return content.map((block: any) => {
    if (block._type === 'block') {
      const children = block.children?.map((child: any) => {
        let text = child.text || '';
        if (child.marks?.includes('strong')) text = `<strong>${text}</strong>`;
        if (child.marks?.includes('em')) text = `<em>${text}</em>`;
        if (child.marks?.includes('code')) text = `<code class="bg-slate-900 text-orange-300 px-2 py-1 rounded">${text}</code>`;
        return text;
      }).join('') || '';

      switch (block.style) {
        case 'h1':
          return `<h1 class="text-4xl font-bold mb-6 mt-8 text-white">${children}</h1>`;
        case 'h2':
          return `<h2 class="text-3xl font-bold mb-4 mt-8 text-white">${children}</h2>`;
        case 'h3':
          return `<h3 class="text-2xl font-bold mb-3 mt-6 text-white">${children}</h3>`;
        case 'blockquote':
          return `<blockquote class="border-l-4 border-orange-500 pl-6 italic my-6 text-gray-300 bg-slate-900 py-4 rounded-r-lg">${children}</blockquote>`;
        default:
          return `<p class="mb-4 leading-relaxed text-gray-300">${children}</p>`;
      }
    } else if (block._type === 'image') {
      const imageUrl = urlFor(block).width(1000).url();
      return `<img src="${imageUrl}" alt="${block.alt || ''}" class="w-full rounded-lg my-8 border border-slate-700" />`;
    }
    return '';
  }).join('');
};
---

<BaseLayout title={`${post.title} - Bilog`} description={post.excerpt}>
  <div class="flex min-h-screen bg-slate-800">
    <Sidebar />
    
    <div class="flex-1 lg:ml-80">
      <!-- Hero Section with Cover Image -->
      <div class="relative h-[50vh] min-h-[400px] overflow-hidden bg-slate-900 border-b border-slate-700">
        {post.coverImage ? (
          <>
            <img 
              src={urlFor(post.coverImage).width(1920).height(1080).url()} 
              alt={post.title}
              class="w-full h-full object-cover opacity-40"
            />
            <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/70 to-slate-900/30"></div>
          </>
        ) : (
          <div class="w-full h-full bg-gradient-to-br from-slate-800 to-slate-900"></div>
        )}
        
        <!-- Post Title Overlay -->
        <div class="absolute inset-0 flex items-end">
          <div class="px-8 pb-12 relative z-10 max-w-7xl">
            {post.category && (
              <span class="inline-block px-4 py-2 bg-orange-500 text-white rounded-lg text-sm font-semibold mb-4 animate-fadeInUp">
                {post.category}
              </span>
            )}
            <h1 class="text-4xl md:text-5xl font-extrabold text-white mb-6 animate-fadeInUp" style="animation-delay: 0.1s;">
              {post.title}
            </h1>
            <div class="flex flex-wrap items-center gap-6 text-gray-300 text-base animate-fadeInUp" style="animation-delay: 0.2s;">
              {post.author && (
                <span class="flex items-center gap-2">
                  <span class="text-xl">üë§</span>
                  {post.author}
                </span>
              )}
              {post.publishedAt && (
                <span class="flex items-center gap-2">
                  <span class="text-xl">üìÖ</span>
                  {formatDate(post.publishedAt)}
                </span>
              )}
            </div>
          </div>
        </div>
      </div>

      <!-- Article Content -->
      <article class="py-12 bg-slate-800">
        <div class="px-8 relative z-10">
          <div class="max-w-5xl">
            <!-- Excerpt -->
            {post.excerpt && (
              <p class="text-xl text-gray-400 leading-relaxed mb-12 pb-12 border-b border-slate-700 scroll-fade-in">
                {post.excerpt}
              </p>
            )}

            <!-- Main Content -->
            {post.content && post.content.length > 0 ? (
              <div class="prose prose-lg prose-invert max-w-none scroll-fade-in" set:html={renderContent(post.content)} />
            ) : (
              <div class="text-center py-12 scroll-fade-in">
                <div class="text-6xl mb-4">üìù</div>
                <p class="text-gray-400 text-lg">No content yet. Add content in Sanity Studio!</p>
              </div>
            )}

            <!-- Tags -->
            {post.tags && post.tags.length > 0 && (
              <div class="mt-12 pt-8 border-t border-slate-700 scroll-fade-in">
                <h3 class="text-sm font-semibold text-gray-500 mb-4">TAGS</h3>
                <div class="flex flex-wrap gap-3">
                  {post.tags.map((tag: string) => (
                    <span class="px-4 py-2 bg-slate-900 border border-slate-700 text-gray-400 rounded-lg font-medium hover:bg-slate-700 hover:text-white transition-all cursor-pointer">
                      #{tag}
                    </span>
                  ))}
                </div>
              </div>
            )}

            <!-- Share Section -->
            <div class="mt-12 pt-8 border-t border-slate-700 scroll-fade-in">
              <h3 class="text-xl font-bold mb-4 text-white">Share this post</h3>
              <div class="flex gap-4">
                <a 
                  href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(post.title)}&url=${Astro.url.href}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="px-6 py-3 bg-slate-900 border border-slate-700 text-white rounded-lg font-semibold hover:bg-blue-500 hover:border-blue-500 transition-all duration-300"
                >
                  üê¶ Twitter
                </a>
                <a 
                  href={`https://www.linkedin.com/sharing/share-offsite/?url=${Astro.url.href}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="px-6 py-3 bg-slate-900 border border-slate-700 text-white rounded-lg font-semibold hover:bg-blue-600 hover:border-blue-600 transition-all duration-300"
                >
                  üíº LinkedIn
                </a>
                <a 
                  href={`mailto:?subject=${encodeURIComponent(post.title)}&body=${encodeURIComponent(post.excerpt + '\n\nRead more: ' + Astro.url.href)}`}
                  class="px-6 py-3 bg-slate-900 border border-slate-700 text-white rounded-lg font-semibold hover:bg-green-600 hover:border-green-600 transition-all duration-300"
                >
                  üìß Email
                </a>
              </div>
            </div>

            <!-- Author Card -->
            {post.author && (
              <div class="mt-12 p-8 bg-slate-900 border border-slate-700 rounded-2xl scroll-fade-in hover:border-orange-500/50 transition-all duration-300">
                <div class="flex items-start gap-6">
                  <div class="w-20 h-20 rounded-full bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center text-4xl shrink-0">
                    üë®‚Äçüíª
                  </div>
                  <div>
                    <h3 class="text-2xl font-bold mb-2 text-white">{post.author}</h3>
                    <p class="text-gray-400 leading-relaxed mb-4">
                      Passionate writer and developer sharing insights about technology, design, and creativity.
                    </p>
                    <a href="/" class="text-orange-500 font-semibold hover:text-orange-400 transition-colors">
                      More posts by {post.author} ‚Üí
                    </a>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      </article>

      <!-- Related Posts -->
      {relatedPosts && relatedPosts.length > 0 && (
        <section class="py-12 bg-slate-900 border-t border-slate-700">
          <div class="px-8 relative z-10">
            <div class="max-w-7xl">
              <h2 class="text-3xl font-bold mb-8 text-white scroll-fade-in">
                Related Posts
              </h2>
              <div class="grid md:grid-cols-3 gap-8">
                {relatedPosts.map((relatedPost: any, index: number) => (
                  <article 
                    class="group bg-slate-800 border border-slate-700 rounded-2xl overflow-hidden hover:border-orange-500/50 hover:-translate-y-1 transition-all duration-300 scroll-fade-in"
                    style={`animation-delay: ${index * 0.1}s;`}
                  >
                    {relatedPost.coverImage && (
                      <div class="relative h-48 overflow-hidden">
                        <img 
                          src={urlFor(relatedPost.coverImage).width(400).height(250).url()} 
                          alt={relatedPost.title}
                          class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"
                        />
                      </div>
                    )}
                    <div class="p-6">
                      <h3 class="text-lg font-bold mb-3 text-white group-hover:text-orange-500 transition-colors line-clamp-2">
                        <a href={`/blog/${relatedPost.slug.current}`}>{relatedPost.title}</a>
                      </h3>
                      <p class="text-gray-400 mb-4 line-clamp-2 text-sm">{relatedPost.excerpt}</p>
                      <a 
                        href={`/blog/${relatedPost.slug.current}`}
                        class="inline-flex items-center gap-2 text-orange-500 font-semibold hover:text-orange-400 transition-colors text-sm"
                      >
                        Read More ‚Üí
                      </a>
                    </div>
                  </article>
                ))}
              </div>
              <div class="text-center mt-12">
                <a 
                  href="/blog"
                  class="inline-block px-8 py-4 bg-orange-500 text-white rounded-lg font-bold hover:bg-orange-600 transition-all duration-300"
                >
                  ‚Üê Back to Blog
                </a>
              </div>
            </div>
          </div>
        </section>
      )}
    </div>
  </div>
</BaseLayout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Prose styling for dark theme */
  .prose-invert {
    color: #d1d5db;
  }

  .prose-invert strong {
    color: #ffffff;
    font-weight: 700;
  }

  .prose-invert a {
    color: #f97316;
    text-decoration: underline;
    font-weight: 500;
  }

  .prose-invert a:hover {
    color: #fb923c;
  }

  .prose-invert ul, .prose-invert ol {
    margin: 1.5em 0;
    padding-left: 1.5em;
    color: #d1d5db;
  }

  .prose-invert li {
    margin: 0.5em 0;
  }
</style>
