---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { sanityClient, urlFor } from '../../lib/sanity';

export async function getStaticPaths() {
  const posts = await sanityClient.fetch(`
    *[_type == "blogPost"] {
      slug
    }
  `);

  return posts.map((post: any) => ({
    params: { slug: post.slug.current }
  }));
}

const { slug } = Astro.params;

// Fetch the blog post
const post = await sanityClient.fetch(`
  *[_type == "blogPost" && slug.current == $slug][0] {
    title,
    slug,
    excerpt,
    coverImage,
    author,
    publishedAt,
    category,
    tags,
    content
  }
`, { slug });

if (!post) {
  return Astro.redirect('/404');
}

// Fetch related posts
const relatedPosts = await sanityClient.fetch(`
  *[_type == "blogPost" && slug.current != $slug && category == $category] | order(publishedAt desc)[0...3] {
    title,
    slug,
    excerpt,
    coverImage,
    publishedAt
  }
`, { slug, category: post.category });

// Format date
const formatDate = (date: string) => {
  return new Date(date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};

// Convert portable text to HTML (simple version)
const renderContent = (content: any[]) => {
  if (!content) return '';
  
  return content.map((block: any) => {
    if (block._type === 'block') {
      const children = block.children?.map((child: any) => {
        let text = child.text || '';
        if (child.marks?.includes('strong')) text = `<strong>${text}</strong>`;
        if (child.marks?.includes('em')) text = `<em>${text}</em>`;
        if (child.marks?.includes('code')) text = `<code class="bg-purple-600/20 text-purple-300 px-2 py-1 rounded">${text}</code>`;
        return text;
      }).join('') || '';

      switch (block.style) {
        case 'h1':
          return `<h1 class="text-4xl font-bold mb-6 mt-8 text-white">${children}</h1>`;
        case 'h2':
          return `<h2 class="text-3xl font-bold mb-4 mt-8 text-white">${children}</h2>`;
        case 'h3':
          return `<h3 class="text-2xl font-bold mb-3 mt-6 text-white">${children}</h3>`;
        case 'blockquote':
          return `<blockquote class="border-l-4 border-purple-500 pl-6 italic my-6 text-gray-300 bg-white/5 py-4 rounded-r-lg">${children}</blockquote>`;
        default:
          return `<p class="mb-4 leading-relaxed text-gray-300">${children}</p>`;
      }
    } else if (block._type === 'image') {
      const imageUrl = urlFor(block).width(1000).url();
      return `<img src="${imageUrl}" alt="${block.alt || ''}" class="w-full rounded-lg my-8 border border-white/10" />`;
    }
    return '';
  }).join('');
};
---

<BaseLayout title={`${post.title} - Bil√≥g`} description={post.excerpt}>
  <!-- Hero Section with Cover Image and Floating Blobs -->
  <div class="relative h-[60vh] min-h-[400px] overflow-hidden bg-black">
    <!-- Floating blobs -->
    <div class="absolute inset-0 opacity-20 pointer-events-none">
      <div class="absolute top-0 left-0 w-96 h-96 bg-purple-600 rounded-full filter blur-3xl animate-float"></div>
      <div class="absolute bottom-0 right-0 w-96 h-96 bg-indigo-600 rounded-full filter blur-3xl animate-float-slow"></div>
    </div>

    {post.coverImage ? (
      <>
        <img 
          src={urlFor(post.coverImage).width(1920).height(1080).url()} 
          alt={post.title}
          class="w-full h-full object-cover opacity-60"
        />
        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/70 to-black/30"></div>
      </>
    ) : (
      <div class="w-full h-full bg-gradient-to-br from-purple-900/50 to-black"></div>
    )}
    
    <!-- Post Title Overlay -->
    <div class="absolute inset-0 flex items-end">
      <div class="container mx-auto px-4 pb-12 relative z-10">
        <div class="max-w-4xl">
          {post.category && (
            <span class="inline-block px-4 py-2 bg-purple-600 text-white rounded-full text-sm font-semibold mb-4 animate-fadeInUp">
              {post.category}
            </span>
          )}
          <h1 class="text-4xl md:text-6xl font-extrabold text-white mb-6 animate-fadeInUp" style="animation-delay: 0.1s;">
            {post.title}
          </h1>
          <div class="flex flex-wrap items-center gap-6 text-gray-300 text-lg animate-fadeInUp" style="animation-delay: 0.2s;">
            {post.author && (
              <span class="flex items-center gap-2">
                <span class="text-2xl">üë§</span>
                {post.author}
              </span>
            )}
            {post.publishedAt && (
              <span class="flex items-center gap-2">
                <span class="text-2xl">üìÖ</span>
                {formatDate(post.publishedAt)}
              </span>
            )}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Article Content -->
  <article class="py-16 bg-black relative overflow-hidden">
    <!-- Background blob -->
    <div class="absolute inset-0 opacity-10 pointer-events-none">
      <div class="absolute top-1/3 right-0 w-96 h-96 bg-purple-600 rounded-full filter blur-3xl animate-pulse-glow"></div>
    </div>

    <div class="container mx-auto px-4 relative z-10">
      <div class="max-w-4xl mx-auto">
        <!-- Excerpt -->
        {post.excerpt && (
          <p class="text-xl md:text-2xl text-gray-400 leading-relaxed mb-12 pb-12 border-b border-white/10 scroll-fade-in">
            {post.excerpt}
          </p>
        )}

        <!-- Main Content -->
        {post.content && post.content.length > 0 ? (
          <div class="prose prose-lg prose-invert max-w-none scroll-fade-in" set:html={renderContent(post.content)} />
        ) : (
          <div class="text-center py-12 scroll-fade-in">
            <div class="text-6xl mb-4">üìù</div>
            <p class="text-gray-400 text-lg">No content yet. Add content in Sanity Studio!</p>
          </div>
        )}

        <!-- Tags -->
        {post.tags && post.tags.length > 0 && (
          <div class="mt-12 pt-8 border-t border-white/10 scroll-fade-in">
            <h3 class="text-sm font-semibold text-gray-500 mb-4">TAGS</h3>
            <div class="flex flex-wrap gap-3">
              {post.tags.map((tag: string) => (
                <span class="px-4 py-2 bg-purple-600/20 border border-purple-500/30 text-purple-300 rounded-full font-medium hover:bg-purple-600/30 hover:scale-105 transition-transform cursor-pointer">
                  #{tag}
                </span>
              ))}
            </div>
          </div>
        )}

        <!-- Share Section -->
        <div class="mt-12 pt-8 border-t border-white/10 scroll-fade-in">
          <h3 class="text-xl font-bold mb-4 text-white">Share this post</h3>
          <div class="flex gap-4">
            <button class="px-6 py-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 hover:scale-105 transition-all duration-300">
              üê¶ Twitter
            </button>
            <button class="px-6 py-3 bg-blue-700 text-white rounded-lg font-semibold hover:bg-blue-800 hover:scale-105 transition-all duration-300">
              üíº LinkedIn
            </button>
            <button class="px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 hover:scale-105 transition-all duration-300">
              üìß Email
            </button>
          </div>
        </div>

        <!-- Author Card -->
        {post.author && (
          <div class="mt-12 p-8 bg-white/5 backdrop-blur-sm border border-white/10 rounded-2xl scroll-fade-in hover:bg-white/10 transition-all duration-300">
            <div class="flex items-start gap-6">
              <div class="w-20 h-20 rounded-full bg-gradient-to-br from-purple-600 to-indigo-600 flex items-center justify-center text-4xl flex-shrink-0">
                üë®‚Äçüíª
              </div>
              <div>
                <h3 class="text-2xl font-bold mb-2 text-white">{post.author}</h3>
                <p class="text-gray-400 leading-relaxed mb-4">
                  Passionate writer and developer sharing insights about technology, design, and creativity.
                </p>
                <a href="/" class="text-purple-400 font-semibold hover:text-purple-300 transition-colors">
                  More posts by {post.author} ‚Üí
                </a>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  </article>

  <!-- Related Posts -->
  {relatedPosts && relatedPosts.length > 0 && (
    <section class="py-16 bg-zinc-950 relative overflow-hidden">
      <!-- Background blob -->
      <div class="absolute inset-0 opacity-10 pointer-events-none">
        <div class="absolute bottom-0 left-0 w-96 h-96 bg-indigo-600 rounded-full filter blur-3xl animate-float-slow"></div>
      </div>

      <div class="container mx-auto px-4 relative z-10">
        <h2 class="text-4xl font-bold mb-12 text-center scroll-fade-in">
          <span class="gradient-text">
            Related Posts
          </span>
        </h2>
        <div class="grid md:grid-cols-3 gap-8 max-w-6xl mx-auto">
          {relatedPosts.map((relatedPost: any, index: number) => (
            <article 
              class="group bg-white/5 backdrop-blur-sm border border-white/10 rounded-2xl overflow-hidden hover:bg-white/10 hover:border-purple-500/50 hover:-translate-y-2 hover:shadow-2xl hover:shadow-purple-500/20 transition-all duration-500 scroll-fade-in"
              style={`animation-delay: ${index * 0.1}s;`}
            >
              {relatedPost.coverImage && (
                <div class="relative h-48 overflow-hidden">
                  <img 
                    src={urlFor(relatedPost.coverImage).width(400).height(250).url()} 
                    alt={relatedPost.title}
                    class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"
                  />
                </div>
              )}
              <div class="p-6">
                <h3 class="text-xl font-bold mb-3 text-white group-hover:text-purple-400 transition-colors line-clamp-2">
                  <a href={`/blog/${relatedPost.slug.current}`}>{relatedPost.title}</a>
                </h3>
                <p class="text-gray-400 mb-4 line-clamp-2 text-sm">{relatedPost.excerpt}</p>
                <a 
                  href={`/blog/${relatedPost.slug.current}`}
                  class="inline-flex items-center gap-2 text-purple-400 font-semibold hover:text-purple-300 transition-colors text-sm"
                >
                  Read More
                  <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                </a>
              </div>
            </article>
          ))}
        </div>
        <div class="text-center mt-12">
          <a 
            href="/blog"
            class="inline-block px-8 py-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-full font-bold hover:scale-105 hover:shadow-lg hover:shadow-purple-500/50 transition-all duration-300"
          >
            ‚Üê Back to Blog
          </a>
        </div>
      </div>
    </section>
  )}
</BaseLayout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Prose styling for dark theme */
  .prose-invert {
    color: #d1d5db;
  }

  .prose-invert strong {
    color: #ffffff;
    font-weight: 700;
  }

  .prose-invert a {
    color: #a78bfa;
    text-decoration: underline;
    font-weight: 500;
  }

  .prose-invert a:hover {
    color: #c4b5fd;
  }

  .prose-invert ul, .prose-invert ol {
    margin: 1.5em 0;
    padding-left: 1.5em;
    color: #d1d5db;
  }

  .prose-invert li {
    margin: 0.5em 0;
  }
</style>
