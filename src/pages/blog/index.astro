---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Sidebar from '../../components/Sidebar.astro';
import { sanityClient, urlFor } from '../../lib/sanity';
import { CalendarDays, BookOpen, FileText } from 'lucide-astro';

// Fetch all blog posts with optimized query
const allPosts = await sanityClient.fetch(`
  *[_type == "blogPost"] | order(publishedAt desc) {
    title,
    "slug": slug.current,
    excerpt,
    coverImage,
    author,
    publishedAt,
    category,
    tags,
    featured
  }
`) || [];

// Separate featured posts
const featuredPosts = allPosts.filter((post: any) => post.featured);
const regularPosts = allPosts.filter((post: any) => !post.featured);

// Get unique categories
const categories = [...new Set(allPosts.map((post: any) => post.category).filter(Boolean))];

// Category display names
const categoryNames: Record<string, string> = {
  'travel': 'Must Visit Places',
  'food': 'Must Try Things',
  'technology': 'Tech Tips',
  'photography': 'Photography',
  'personal': 'Life & Experiences',
  'guides': 'Travel Guides',
  'design': 'Design',
  'tutorial': 'Tutorial',
};

// Format date helper
const formatDate = (date: string) => {
  return new Date(date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};
---

<BaseLayout title="Blog - Bilog" description="Read my latest thoughts on technology, design, and life">
  <div class="flex min-h-screen bg-slate-800">
    <Sidebar />
    
    <div class="flex-1 lg:ml-80">
      
     

      <!-- Category Filter Section -->
      
      </div>
    </section>
  

  <!-- All Posts Grid -->
  <section class="py-8 px-8 bg-slate-800">
    <div class="max-w-7xl">
      
      {regularPosts.length === 0 && featuredPosts.length === 0 ? (
        <div class="text-center py-20">
          <div class="mb-6 flex justify-center">
            <FileText size={80} class="text-gray-600" />
          </div>
          <h3 class="text-3xl font-bold text-white mb-4">No Posts Yet</h3>
          <p class="text-gray-400 text-lg">Check back soon for new content!</p>
        </div>
      ) : (
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="posts-grid">
          {(regularPosts.length > 0 ? regularPosts : featuredPosts).map((post: any, index: number) => (
            <article 
              class="group bg-slate-900 border border-slate-700 rounded-2xl overflow-hidden hover:border-orange-500/50 hover:-translate-y-1 transition-all duration-300 post-card"
              data-category={post.category || 'uncategorized'}
            >
              {post.coverImage ? (
                <div class="relative h-48 overflow-hidden">
                  <img 
                    src={urlFor(post.coverImage).width(500).height(300).url()} 
                    alt={post.title}
                    class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"
                  />
                  {post.category && (
                    <span class="absolute top-3 right-3 px-3 py-1 bg-orange-500 text-white rounded-lg text-xs font-semibold">
                      {post.category}
                    </span>
                  )}
                </div>
              ) : (
                <div class="h-56 bg-gradient-to-br from-purple-600/20 to-indigo-600/20 flex items-center justify-center">
                  <BookOpen size={60} class="text-purple-400" />
                </div>
              )}
              <div class="p-6">
                <div class="flex items-center gap-3 text-xs text-gray-500 mb-3">
                  {post.publishedAt && (
                    <span class="flex items-center gap-1">
                      <CalendarDays size={14} /> {formatDate(post.publishedAt)}
                    </span>
                  )}
                </div>
                <h3 class="text-lg font-bold mb-3 text-white group-hover:text-orange-500 transition-colors duration-300 line-clamp-2">
                  <a href={`/blog/${post.slug.current}`}>{post.title}</a>
                </h3>
                <p class="text-gray-400 mb-4 line-clamp-2 text-sm">{post.excerpt}</p>
                <a 
                  href={`/blog/${post.slug.current}`}
                  class="inline-flex items-center gap-2 text-orange-500 font-semibold hover:text-orange-400 transition-colors text-sm"
                >
                  Read More â†’
                </a>
              </div>
            </article>
          ))}
        </div>
      )}
    </div>
  </section>


  </div>
  </div>
</BaseLayout>

<script>
  // Category names mapping
  const categoryNames: Record<string, string> = {
    'travel': 'Must Visit Places',
    'food': 'Must Try Things',
    'technology': 'Tech Tips',
    'photography': 'Photography',
    'personal': 'Life & Experiences',
    'guides': 'Travel Guides',
    'design': 'Design',
    'tutorial': 'Tutorial',
  };

  // Check URL for category parameter
  const urlParams = new URLSearchParams(window.location.search);
  const urlCategory = urlParams.get('category');

  // Category filter functionality
  const filterButtons = document.querySelectorAll('.category-filter');
  const postCards = document.querySelectorAll('.post-card');
  const pageTitle = document.getElementById('page-title');
  const pageDescription = document.getElementById('page-description');

  // Apply filter from URL on page load
  if (urlCategory) {
    filterByCategory(urlCategory);
    updateActiveButton(urlCategory);
  }

  filterButtons.forEach(button => {
    button.addEventListener('click', () => {
      const category = button.getAttribute('data-category');
      filterByCategory(category);
      updateActiveButton(category);
      
      // Update URL without reload
      if (category === 'all') {
        window.history.pushState({}, '', '/blog');
      } else {
        window.history.pushState({}, '', `/blog?category=${category}`);
      }
    });
  });

  function filterByCategory(category: string) {
    // Update page title and description
    if (category && category !== 'all' && categoryNames[category]) {
      if (pageTitle) pageTitle.textContent = categoryNames[category];
      if (pageDescription) pageDescription.textContent = `Explore posts about ${categoryNames[category].toLowerCase()}`;
    } else {
      if (pageTitle) pageTitle.textContent = 'All Posts';
      if (pageDescription) pageDescription.textContent = 'Explore my personal blog about travel, food, tech, and life experiences';
    }

    // Filter posts
    postCards.forEach(card => {
      const postCategory = card.getAttribute('data-category');
      if (category === 'all' || postCategory === category) {
        (card as HTMLElement).style.display = 'block';
        card.classList.add('animate-fadeIn');
      } else {
        (card as HTMLElement).style.display = 'none';
      }
    });
  }

  function updateActiveButton(category: string) {
    filterButtons.forEach(btn => {
      const btnCategory = btn.getAttribute('data-category');
      if (btnCategory === category) {
        btn.classList.add('bg-orange-500', 'text-white');
        btn.classList.remove('bg-slate-700', 'text-gray-300');
      } else {
        btn.classList.remove('bg-orange-500', 'text-white');
        btn.classList.add('bg-slate-700', 'text-gray-300');
      }
    });
  }
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
